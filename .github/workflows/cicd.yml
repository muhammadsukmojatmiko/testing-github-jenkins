name: CI-CD

on:
  pull_request:
    branches:
      - main
      - staging
      - release/*
      - feat/*
env:
  GITHUB_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
  USERNAME: ${{ secrets.USERNAME }}
  PASSWORD: ${{ secrets.PASSWORD }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  automation:
    name: Setup, check, build & deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js 18.x
        uses: actions/setup-node@v3
        with:
          always-auth: true
          node-version: 18.x

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install dependencies
        env:
          CI: true
        run: YARN_ENABLE_IMMUTABLE_INSTALLS=false yarn install

      - name: Run lint
        run: yarn lint

      - name: Run test
        run: yarn test

      # Generate '.env.production' with content from '.env.base.xxx'
      # because next only consume from '.env.production'
      - name: Generate local env
        run: ./generate_dotenv.sh staging

      # VERCEL
      - name: Install Vercel CLI
        run: npm install --global vercel@canary

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy-vercel
        run: echo "url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})" >> $GITHUB_OUTPUT

      # Publish the inspect and preview link to Slack
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ğŸ‰ Deploy preview ready!
            Built with latest commit ${{ github.sha }}

            backoffice-logistic-web
            Issue: ${{ github.event.pull_request.title }}
            Preview url: ${{ steps.deploy-vercel.outputs.url }}
      - if: success()
        uses: wearerequired/slack-messaging-action@v2
        with:
          bot_token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: buddyworks-logistic-web
          payload: >-
            {
              "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ›  Build & Deployment"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Hi <!channel> ğŸ‘‹"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Your pull request is successfully build & deployed! ğŸ‰"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "â€¢ Project: backoffice-logistic-web \n â€¢ Issue: ${{ github.event.pull_request.title }}  \n â€¢ Preview url: ${{ steps.deploy-vercel.outputs.url }}"
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "ğŸ‘¨â€ğŸ’» Author: ${{ github.event.sender.login }} \n ğŸŒ PR url: https://github.com/Agriaku/backoffice-logistic-web/pull/${{ github.event.number }} \n ğŸ“ Commit sha: <https://github.com/Agriaku/backoffice-logistic-web/commit/${{ github.sha }}|${{ github.sha }}>"
                    }
                  }
                ]
            }
      - if: failure()
        uses: wearerequired/slack-messaging-action@v2
        with:
          bot_token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel: buddyworks-logistic-web
          payload: >-
            {
              "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ›  BO Logistic Build & Deployment - #${{ github.event.number }}"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Hi <!channel> ğŸ‘‹"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Your pull request build & deployment is fail! ğŸ¤¦ğŸ»â€â™‚ï¸"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "ğŸ‘¨â€ğŸ’» Author: ${{ github.event.sender.login }} \n ğŸŒ PR url: https://github.com/Agriaku/backoffice-logistic-web/pull/${{ github.event.number }} \n ğŸ“ Commit sha: <https://github.com/Agriaku/backoffice-logistic-web/commit/${{ github.sha }}|${{ github.sha }}>"
                    }
                  }
                ]
            }
